<form [formGroup]="form" *contra="let c">
  <label for="map-region">{{ c['gisMap'] }}</label>
  <div class="flex gap-2 mbe-6">
    <div class="grow">
      <div class="fc">
        <pui-select-input
          labelRef="map-region"
          formControlName="region"
          [list]="'' | regions | async | arrayMap : mapRegion"
        ></pui-select-input>
      </div>
    </div>
    <div class="grow">
      <div class="fc">
        <pui-select-input
          labelRef="gis-map"
          formControlName="map"
          [list]="
            (regionCtrl.value | region | async)?.gis ?? null
              | arrayMap : mapMaps
          "
        >
        </pui-select-input>
      </div>
    </div>
  </div>

  <label for="gis-layers">{{ c['gisLayers'] }}</label>
  <div class="fc mbe-6">
    <pui-multi-select-input
      labelRef="gis-layers"
      formControlName="layers"
      [list]="
        (
          (regionCtrl.value | region | async)?.gis ?? null
          | arrayFind : findMap : mapCtrl.value
        )?.layers ?? null | arrayMap : mapLayer
      "
    >
    </pui-multi-select-input>
  </div>

  <div class="toolbar gap-2 mbe-6">
    <h4>{{ c['externalLayers'] }}</h4>
    <div class="grow"></div>
    <button class="btn-small btn-round btn-icon" (click)="addExternalLayer()">
      <i puiIcon="add" size="small"></i>
    </button>
  </div>

  <ng-container formArrayName="external_layers">
    <div
      *ngFor="let g of extLayersCtrl.controls; let i = index"
      class="flex gap-2 align-items-end mbe-6"
      [formGroup]="g"
    >
      <div class="grow">
        <label [for]="i + '-layer-name'">{{ c['name'] }}</label>
        <div class="fc">
          <input type="text" [id]="i + '-layer-name'" formControlName="name" />
        </div>
      </div>
      <div class="grow">
        <label [for]="i + '-layer-url'">{{ c['url'] }}</label>
        <div class="fc">
          <input type="text" [id]="i + '-layer-url'" formControlName="url" />
        </div>
      </div>
      <button
        class="btn-round btn-icon btn-danger"
        (click)="extLayersCtrl.removeAt(i)"
      >
        <i puiIcon="delete" size="small"></i>
      </button>
    </div>
  </ng-container>

  <div class="toolbar gap-2 mbe-6">
    <h4>{{ c['customLayers'] }}</h4>
    <div class="grow"></div>
    <button class="btn-small btn-round btn-icon" (click)="addCustomLayer()">
      <i puiIcon="add" size="small"></i>
    </button>
  </div>

  <ng-container formArrayName="custom_layers">
    <fieldset
      *ngFor="let g of cusLayersCtrl.controls; let i = index"
      [formGroup]="g"
      class="mbe-6"
    >
      <legend>
        <h5>{{ i + 1 }} {{ c['layer'] }}</h5>
        <button class="btn-tiny btn-icon btn-round btn-danger">
          <i puiIcon="delete" size="tiny"></i>
        </button>
      </legend>

      <div class="flex gap-2 mbe-4">
        <div class="grow">
          <label [for]="i + '-layer-name'">{{ c['name'] }}</label>
          <div class="fc">
            <input
              type="text"
              formControlName="name"
              [id]="i + '-layer-name'"
            />
          </div>
        </div>
        <div class="grow">
          <label [for]="i + '-layer-type'">{{ c['type'] }}</label>
          <div class="fc">
            <pui-select-input
              [labelRef]="i + '-layer-type'"
              [list]="c['layerTypes']"
              formControlName="type"
            >
            </pui-select-input>
          </div>
        </div>

        <div class="flex gap-2 mbe-4">
          <div class="grow">
            <label [for]="i + '-name-field'">{{ c['nameField'] }}</label>
            <div class="fc">
              <pui-select-input
                [list]="
                  dsFields
                    | arrayFilter : filterTitleField
                    | arrayMap : mapField
                "
                formControlName="title_field"
                [labelRef]="i + '-name-field'"
              >
              </pui-select-input>
            </div>
          </div>
          <div class="grow">
            <label [for]="i + '-details-fields'">{{
              c['detailsFields']
            }}</label>
            <div class="fc">
              <pui-multi-select-input
                [labelRef]="i + '-details-fields'"
                [list]="dsFields | arrayMap : mapField"
                formControlName="detailsFields"
              >
              </pui-multi-select-input>
            </div>
          </div>
        </div>

        <div
          class="flex gap-2 mbe-4"
          *ngIf="cusLayersCtrl.at(i).controls.type.value === 'point'"
        >
          <div class="grow">
            <label [for]="i + '-location-field'">{{
              c['locationField']
            }}</label>
            <div class="fc">
              <pui-select-input
                [labelRef]="i + '-location-field'"
                [list]="
                  dsFields | arrayFilter : filterLocField | arrayMap : mapField
                "
                formControlName="location_field"
              >
              </pui-select-input>
            </div>
          </div>

          <div class="grow">
            <label [for]="i + '-size-field'">{{ c['sizeField'] }}</label>
            <div class="fc">
              <pui-select-input
                [labelRef]="i + '-size-field'"
                [list]="
                  dsFields
                    | arrayFilter : filterValueField
                    | arrayMap : mapField
                "
                formControlName="size_field"
              >
              </pui-select-input>
            </div>
          </div>
        </div>

        <ng-container
          *ngIf="cusLayersCtrl.at(i).controls.type.value !== 'point'"
        >
          <label [for]="i + '-region-field'">{{ c['regionField'] }}</label>
          <div class="fc">
            <pui-select-input
              [labelRef]="i + '-region-field'"
              [list]="
                dsFields | arrayFilter : filterLocField | arrayMap : mapField
              "
              formControlName="region_field"
            >
            </pui-select-input>
          </div>
        </ng-container>

        <div class="flex gap-2 mbe-4">
          <div class="grow">
            <label [for]="i + '-color-field'">{{ c['colorField'] }}</label>
            <div class="fc">
              <pui-select-input
                [labelRef]="i + '-color-field'"
                [list]="
                  dsFields
                    | arrayFilter : filterValueField
                    | arrayMap : mapField
                "
                formControlName="color_field"
              >
              </pui-select-input>
            </div>
          </div>
          <div class="grow">
            <label [for]="i + '-opacity-field'">{{ c['opacityField'] }}</label>
            <div class="fc">
              <pui-select-input
                [labelRef]="i + '-opacity-field'"
                [list]="
                  dsFields
                    | arrayFilter : filterValueField
                    | arrayMap : mapField
                "
                formControlName="opacity_field"
              >
              </pui-select-input>
            </div>
          </div>
        </div>

        <ng-container
          formArrayName="colorRange"
          *ngIf="cusLayersCtrl.at(i).controls.color_field.value"
        >
          <div class="toolbar gap-2 mbe-4">
            <h5>{{ c['colorRange'] }}</h5>
            <div class="grow"></div>
            <button
              class="btn-icon btn-tiny btn-icon"
              (click)="addColorRange(i)"
            >
              <i puiIcon="add" size="tiny"></i>
            </button>
          </div>

          <div
            *ngFor="
              let cg of cusLayersCtrl.at(i).controls.color_range.controls;
              let j = index
            "
            [formGroup]="cg"
            class="flex gap-2 align-items-end mbe-4"
          >
            <div class="grow">
              <label [for]="i + '-' + j + 'color'">{{ c['color'] }}</label>
              <div class="fc">
                <input
                  type="color"
                  [id]="i + '-' + j + 'color'"
                  formControlName="color"
                />
              </div>
            </div>
            <div class="grow">
              <label [for]="i + '-' + j + 'value'">{{ c['value'] }}</label>
              <div class="fc">
                <input
                  type="number"
                  [id]="i + '-' + j + 'value'"
                  formControlName="value"
                />
              </div>
            </div>
            <div class="grow">
              <label [for]="i + '-' + j + 'label'">{{ c['label'] }}</label>
              <div class="fc">
                <input
                  type="text"
                  [id]="i + '-' + j + 'label'"
                  formControlName="label"
                />
              </div>
            </div>
            <button
              class="btn-round btn-icon"
              (click)="cusLayersCtrl.at(i).controls.color_range.removeAt(j)"
            >
              <i puiIcon="delete" size="tiny" color="danger"></i>
            </button>
          </div>
        </ng-container>
      </div>
    </fieldset>
  </ng-container>
</form>
