<ng-container *contra="let c">
  <p *ngIf="rState === drState.PUBLISHED" class="badge badge-success">
    {{c['approved']}}
  </p>
  <button
    *ngIf="rState === drState.DRAFT"
    class="btn-round btn-outline"
    [disabled]="!editable"
    (click)="openDialog(publishTmp)"
  >
    {{c['draft']}}
    <i puiIcon="arrow_drop_down" size="small"></i>
  </button>

  <ng-container *ngIf="rState === drState.REVIEW">
    <button
      #reviewBadge
      class="btn-round btn-primary"
      (click)="workflowStack.show()"
    >
      {{c['review']}}
      <i puiIcon="arrow_drop_down" size="small"></i>
    </button>

    <pui-dropdown #workflowStack [origin]="reviewBadge">
      <div class="card shadow-4 card-small w-10">
        <div class="card-body" *ngIf="rWorkflow | async as steps">
          <div
            *ngFor="let step of steps; let last = last"
            class="card card-clear bordered"
            [class.mbe-2]="!last"
          >
            <div class="card-header">
              <h5>{{step.trigger}}</h5>
              <div class="grow"></div>
              <p class="f9">{{step.create_date | date: 'dd-MM-yyyy'}}</p>
            </div>
            <div class="card-body list">
              <ng-container *ngFor="let a of step.actions">
                <div class="list-item pi-4">
                  <p *ngIf="a.date">{{a.date | date: 'dd-MM-yyyy'}}</p>
                  <div class="grow"></div>
                  <i
                    *ngIf="a.user !== user || a.action !== wAction.REVIEW"
                    [puiIcon]="icons[a.action]"
                    size="tiny"
                  ></i>
                  <ng-container
                    *ngIf="a.user === user || a.action === wAction.REVIEW"
                  >
                    <button
                      class="btn-icon btn-tiny btn-round btn-success"
                      (click)="preAction = wAction.APPROVE"
                    >
                      <i puiIcon="check" size="tiny"></i>
                    </button>
                    <button
                      class="btn-icon btn-tiny btn-round btn-danger"
                      (click)="preAction = wAction.REJECT"
                    >
                      <i puiIcon="close" size="tiny"></i>
                    </button>
                  </ng-container>
                  <pui-preloader
                    *ngIf="a.user === user && loading"
                  ></pui-preloader>
                </div>
                <p *ngIf="a.message" class="p-4 f9 text3">{{a.message}}</p>
                <div class="p-4 flex gap-2" *ngIf="preAction">
                  <div class="fc fc-small">
                    <input #msg type="text" />
                  </div>
                  <button
                    *ngIf="preAction === wAction.APPROVE"
                    class="btn-small btn-success"
                    (click)="approve(step.step, msg.value)"
                  >
                    {{c['approve']}}
                  </button>
                  <button
                    *ngIf="preAction === wAction.REJECT"
                    class="btn-small btn-danger"
                    (click)="reject(step.step, msg.value)"
                  >
                    {{c['reject']}}
                  </button>
                  <button
                    class="btn-small btn-outlne"
                    (click)="preAction = null"
                  >
                    {{c['cancel']}}
                  </button>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </div>
    </pui-dropdown>
  </ng-container>

  <ng-template #publishTmp>
    <div class="card shadow-6 w-10">
      <h4 class="card-header">{{c['publish']}} {{c['record']}}</h4>
      <p>{{c['confirmPublish']}}</p>
      <div class="card-footer">
        <button class="btn-outline btn-round" (click)="closeDialog()">{{c['cancel']}}</button>
        <button class="btn-primary btn-round" (click)="publish()">{{c['publish']}}</button>
      </div>
    </div>
  </ng-template>
</ng-container>
